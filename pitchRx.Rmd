\chapter{TAMING PITCHF/X DATA WITH XML2R AND PITCHRX}

This chapter is a paper published in _The R Journal_ [@Sievert:2014a]. I am the sole author of the paper which is avaliable online here https://journal.r-project.org/archive/2014-1/sievert.pdf 

The formatting of paper has been modified to make for consistent typesetting across the thesis.

\begin{center}
  \begin{Large}
    \textbf{Abstract}
  \end{Large}
\end{center}

\textbf{XML2R} is a framework that reduces the effort required to transform
XML content into tables in a way that preserves parent to child relationships.
\textbf{pitchRx} applies \textbf{XML2R}'s grammar for XML manipulation
to Major League Baseball Advanced Media (MLBAM)'s Gameday data. With
\textbf{pitchRx}, one can easily obtain and store Gameday data in a
remote database. The Gameday website hosts a wealth of XML data, but
perhaps most interesting is PITCHf/x. Among other things, PITCHf/x
data can be used to recreate a baseball's flight path from a pitcher's
hand to home plate. With \textbf{pitchRx}, one can easily create animations
and interactive 3D scatterplots of the baseball's flight path. PITCHf/x
data is also commonly used to generate a static plot of baseball locations
at the moment they cross home plate. These plots, sometimes called
\textit{strike-zone plots}, can also refer to a plot of event probabilities
over the same region. \textbf{pitchRx} provides an easy and robust way
to generate strike-zone plots using the \textbf{ggplot2} package.

# Introduction

## What is PITCHf/x?

PITCHf/x is a general term for a system that generates a series of
3D measurements of a baseball's path from a pitcher's hand to home
plate [@patent].
\footnote{A \textit{pitcher} throws a ball to the opposing \textit{batter}, who
stands besides home plate and tries to hit the ball into the field
of play.
} In an attempt to estimate the location of the ball at any time point,
a quadratic regression model with nine parameters (defined by the
equations of motion for constant linear acceleration) is fit to each
pitch. Studies with access to the actual measurements suggest that
this model is quite reasonable -- especially for non-knuckleball pitches
[@trajecoryAnalysis]. That is, the fitted path often provides
a reasonable estimate (within a couple of inches) of the actual locations.
Unfortunately, only the parameter estimates are made available to
the public. The website that provides these estimates is maintained
by MLBAM and hosts a wealth of other baseball related data used to
inform MLB's Gameday webcast service in near real time.


## Why is PITCHf/x important?

On the business side of baseball, using statistical analysis to scout
and evaluate players has become mainstream. When PITCHf/x was first
introduced, @slate proclaimed it as, \begin{quote} ``The new technology that will change statistical analysis [of baseball] forever.'' \end{quote}
PITCHf/x has yet to fully deliver this claim, partially due to the
difficulty in accessing and deriving insight from the large amount
of complex information. By providing better tools to collect and visualize
this data, \textbf{pitchRx} makes PITCHf/x analysis more accessible
to the general public.


## PITCHf/x applications

PITCHf/x data is and can be used for many different projects. It can
also complement other baseball data sources, which poses an interesting
database management problem. Statistical analysis of PITCHf/x data
and baseball in general has become so popular that it has helped expose
statistical ideas and practice to the general public. If you have
witnessed television broadcasts of MLB games, you know one obvious
application of PITCHf/x is locating pitches in the strike-zone as
well as recreating flight trajectories, tracking pitch speed, etc.
Some on-going statistical research related to PITCHf/x includes: classifying
pitch types, predicting pitch sequences, and clustering pitchers with
similar tendencies [@curve].


\subsection[Contributions of pitchRx and XML2R]{Contributions of \textbf{pitchRx} and \textbf{XML2R}}

The \textbf{pitchRx} package has two main focuses [@pitchRx]. The first focus
is to provide easy access to Gameday data. Not only is \textbf{pitchRx}
helpful for collecting this data in bulk, but it has served as a helpful
teaching and research aide (\url{http://baseballwithr.wordpress.com/}
is one such example). Methods for collecting Gameday data existed
prior to \textbf{pitchRx}; however, these methods are not easily extensible
and require juggling technologies that may not be familiar or accessible
[@database]. Moreover, these working environments are less desirable
than R for data analysis and visualization. Since \textbf{pitchRx} is
built upon \textbf{XML2R}'s united framework, it can be easily modified
and/or extended [@XML2R]. For this same reason, \textbf{pitchRx}
serves as a model for building customized XML data collection tools
with \textbf{XML2R}.

The other main focus of \textbf{pitchRx} is to simplify the process
creating popular PITCHf/x graphics. Strike-zone plots and animations
made via \textbf{pitchRx} utilize the extensible \textbf{ggplot2}
framework as well as various customized options [@ggplot2].
\textbf{ggplot2} is a convenient framework for generating strike-zone
plots primarily because of its facet schema which allows one to make
visual comparisons across any combination of discrete variable(s).
Interactive 3D scatterplots are based on the \textbf{rgl} package
and useful for gaining a new perspective on flight trajectories [@rgl].


# Getting familiar with Gameday

Gameday data is hosted and made available for free thanks to MLBAM
via \url{http://gd2.mlb.com/components/game/mlb/}.
\footnote{Please be respectful of this service and store any information after
you extract it instead of repeatedly querying the website. Before
using any content from this website, please also read the \href{http://gdx.mlb.com/components/copyright.txt}{copyright}.
} From this website, one can obtain many different types of data besides
PITCHf/x. For example, one can obtain everything from \href{http://gd2.mlb.com/components/game/mlb/year_2013/month_07/day_16/gid_2013_07_16_aasmlb_nasmlb_1/media/instadium.xml}{structured media metadata}
to \href{http://gd2.mlb.com/components/game/mlb/twitter/anaInsiderTweets.xml}{insider tweets}.
In fact, this website's purpose is to serve data to various \url{http://mlb.com}
web pages and applications. As a result, some data is redundant and
the format may not be optimal for statistical analysis. For these
reasons, the \texttt{scrape} function is focused on retrieving data
that is useful for PITCHf/x analysis and providing it in a convenient
format for data analysis. 

Navigating through the MLBAM website can be overwhelming, but it helps
to recognize that a homepage exists for nearly every day and every
game. For example, \url{http://gd2.mlb.com/components/game/mlb/year_2011/month_02/day_26/}
displays numerous hyperlinks to various files specific to February
26th, 2011. On this page is a hyperlink to \href{http://gd2.mlb.com/components/game/mlb/year_2011/month_02/day_26/miniscoreboard.xml}{miniscoreboard.xml}
which contains information on every game played on that date. This
page also has numerous hyperlinks to game specific pages. For example,
\href{http://gd2.mlb.com/components/game/mlb/year_2011/month_02/day_26/gid_2011_02_26_phimlb_nyamlb_1/}{gid\_2011\_02\_26\_phimlb\_nyamlb\_1/}
points to the homepage for that day's game between the NY Yankees
and Philadelphia Phillies. On this page is a hyperlink to the \href{http://gd2.mlb.com/components/game/mlb/year_2011/month_02/day_26/gid_2011_02_26_phimlb_nyamlb_1/players.xml}{players.xml}
file which contains information about the players, umpires, and coaches
(positions, names, batting average, etc.) coming into that game. 

Starting from a particular game's homepage and clicking on the \href{http://gd2.mlb.com/components/game/mlb/year_2011/month_02/day_26/gid_2011_02_26_phimlb_nyamlb_1/inning/}{inning/}
directory, we \emph{should} see another page with links to the \href{http://gd2.mlb.com/components/game/mlb/year_2011/month_02/day_26/gid_2011_02_26_phimlb_nyamlb_1/inning/inning_all.xml}{inning\_all.xml}
file and the \href{http://gd2.mlb.com/components/game/mlb/year_2011/month_02/day_26/gid_2011_02_26_phimlb_nyamlb_1/inning/inning_hit.xml}{inning\_hit.xml}
file. If it is available, the \texttt{inning\_all.xml} file contains
the PITCHf/x data for that game. It's important to note that this
file won't exist for some games, because some games are played in
venues that do not have a working PITCHf/x system in place. This is
especially true for preseason games and games played prior to the
2008 season when the PITCHf/x system became widely adopted.
\footnote{In this case, \texttt{scrape} will print ``failed to load HTTP resource''
in the R console (after the relevant file name) to indicate that no
data was available.
} The \texttt{inning\_hit.xml} files have manually recorded spatial
coordinates of where a home run landed or where the baseball made
initial contact with a defender after it was hit into play.

The relationship between these XML files and the tables returned by
\texttt{scrape} is presented in Table \@ref(tab:pitchfx). The \texttt{pitch}
table is extracted from files whose name ends in \texttt{inning\_all.xml}.
This is the only table returned by \texttt{scrape} that contains data
on the pitch-by-pitch level. The \texttt{atbat}, \texttt{runner}, \texttt{action}
and \texttt{hip} tables from this same file are commonly labeled somewhat
ambiguously as play-by-play data. The \texttt{player}, \texttt{coach},
and \texttt{umpire} tables are extracted from \texttt{players.xml} and
are classified as game-by-game since there is one record per person
per game. Figure \@ref(fig:relations) shows how these tables can
be connected to one another in a database setting. The direction of
the arrows represent a one to possibly many relationship. For example,
at least one pitch is thrown for each \textit{at bat} (that is, each
bout between pitcher and batter) and there are numerous at bats within
each game. 

In a rough sense, one can relate tables returned by \texttt{scrape}
back to XML nodes in the XML files. For convenience, some information
in certain XML nodes are combined into one table. For example, information
gleaned from the 'top', 'bottom', and 'inning' XML nodes within \texttt{inning\_all.xml}
are included as \texttt{inning} and \texttt{inning\_side} fields in
the \texttt{pitch}, \texttt{po}, \texttt{atbat}, \texttt{runner}, and
\texttt{action} tables. This helps reduce the burden of merging many
tables together in order to have inning information on the play-by-play
and/or pitch-by-pitch level. Other information is simply ignored simply
because it is redundant. For example, the 'game' node within the \texttt{players.xml}
file contains information that can be recovered from the \texttt{game}
table extracted from the \texttt{miniscoreboard.xml} file. If the reader
wants a more detailed explanation of fields in these tables, @baseball
provide nice overview. 

```{r pitchfx, echo = FALSE}
tab <- tibble::tibble(
  `Source file` = c("miniscoreboard.xml", "", 
                    "players.xml", "", 
                    "inning_all.xml", "", "",
                    "inning_hit.xml"),
  Information = c("game-by-game", "",
                  "game-by-game", "",
                  "play-by-play,","pitch-by-pitch", "",
                  "play-by-play"),
  `XML nodes` = c("games, game", "game_media, media",
                  "game, team, player,", "coach, umpire",
                  "game, inning, bottom,", "top, atbat, po,", "pitch, runner action",
                  "hitchart, hip"),
  `Tables Returned` = c("game, media", "",
                        "player, coach,", "umpire",
                        "atbat, po,", "pitch, runner,", "action",
                        "hip")
)
knitr::kable(
  tab, booktabs = TRUE, format.args = list(width = 10),
  caption = "Structure of PITCHf/x and related Gameday data sources accessible to `scrape()`"
)
```

```{r relations, echo = FALSE, fig.cap = "Table relations between Gameday data accessible via `scrape()`. The direction of the arrows indicate a one to possibly many relationship."}
knitr::include_graphics("images/Drawing1")
```

# Introducing XML2R

\textbf{XML2R} adds to the \href{http://cran.r-project.org/web/views/WebTechnologies.html}{CRAN Task View on Web Technologies and Services}
by focusing on the transformation of XML content into a collection
of tables. Compared to a lower-level API like the \textbf{XML} package,
it can significantly reduce the amount of coding and cognitive effort
required to perform such a task. In contrast to most higher-level
APIs, it does not make assumptions about the XML structure or its
source. Although \textbf{XML2R} works on any structure, performance
and user experience are enhanced if the content has an inherent relational
structure. \textbf{XML2R}'s novel approach to XML data collection breaks
down the transformation process into a few simple steps and allows
the user to decide how to apply those steps.

The next few sections demonstrate how \textbf{pitchRx} leverages \textbf{XML2R}
in order to produce a collection of tables from \texttt{inning\_all.xml}
files. A similar approach is used by \texttt{pitchRx::scrape} to construct
tables from the other Gameday files in Table \@ref(tab:pitchfx).
In fact, \textbf{XML2R} has also been used in the R package \href{https://github.com/cpsievert/bbscrapeR}{bbscrapeR}
which collects data from \href{http://nba.com}{nba.com} and \href{http://wnba.com}{wnba.com}.


## Constructing file names

Sometimes the most frustrating part of obtaining data in bulk off
of the web is finding the proper collection of URLs or file names
of interest. Since files on the Gameday website are fairly well organized,
the \texttt{makeUrls} function can be used to construct \texttt{urls}
that point to every game's homepage within a window of dates.


```{r}
urls <- pitchRx::makeUrls(start = "2011-06-01", end = "2011-06-01") 
sub("http://gd2.mlb.com/components/game/mlb/", "", head(urls))
```

## Extracting observations

Once we have a collection of XML \texttt{files}, the next step is to
parse the content into a list of \textit{observations}. An observation
is technically defined as a matrix with one row and some number of
columns. The columns are defined by XML attributes and the XML value
(if any) for a particular XML lineage. The name of each observation
tracks the XML hierarchy so observations can be grouped together in
a sensible fashion at a later point.


```{r}
library(XML2R)
files <- paste0(urls, "/inning/inning_all.xml")
obs <- XML2Obs(files, url.map = TRUE, quiet = TRUE) 
table(names(obs))
```

This output tells us that 247
pitches were thrown in the bottom inning and 278
were thrown in the top inning on June 1st, 2011. Also, there are 12
different levels of observations. The list element named \texttt{url\_map}
is not considered an observation and was included since \texttt{url.map = TRUE}.
This helps avoid repeating long file names in the \texttt{url\_key}
column which tracks the mapping between observations and file names. 


```{r}
obs[1]
```


## Renaming observations

Before grouping observations into a collection tables based on their
names, one may want to \texttt{re\_name} observations. Observations
with names \texttt{'game//inning//bottom//atbat'} and \texttt{'game//inning//top//atbat'}
should be included in the same table since they share XML attributes
(in other words, the observations share variables). 


```{r}
tmp <- re_name(obs, equiv = c("game//inning//top//atbat",                             
  "game//inning//bottom//atbat"), diff.name = "inning_side") 
```


By passing these names to the \texttt{equiv} argument, \texttt{re\_name}
determines the difference in the naming scheme and suppresses that
difference. In other words, observation names that match the \texttt{equiv}
argument will be renamed to \texttt{'game//inning//atbat'}. The information
removed from the name is not lost; however, as a new column is appended
to the end of each relevant observation. For example, notice how the
\texttt{inning\_side} column contains the part of the name we just
removed:


```{r}
tmp[grep("game//inning//atbat", names(tmp))][1:2]
```

For similar reasons, other observation name pairs are renamed in a
similar fashion.


```{r}
tmp <- re_name(tmp, equiv = c("game//inning//top//atbat//runner",                             
  "game//inning//bottom//atbat//runner"), diff.name = "inning_side")
tmp <- re_name(tmp, equiv = c("game//inning//top//action",                             
  "game//inning//bottom//action"), diff.name = "inning_side")  
tmp <- re_name(tmp, equiv = c("game//inning//top//atbat//po",                            
  "game//inning//bottom//atbat//po"), diff.name = "inning_side")
obs2 <- re_name(tmp, equiv = c("game//inning//top//atbat//pitch",                             
  "game//inning//bottom//atbat//pitch"), diff.name = "inning_side") 
table(names(obs2))
```



## Linking observations

After all that renaming, we now have 7
different levels of observations. Let's examine the first three observations
on the \texttt{game//inning} level:


```{r}
obs2[grep("^game//inning$", names(obs2))][1:3] 
```


Before grouping observations into tables, it is usually important
preserve the parent-to-child relationships in the XML lineage. For
example, one may want to map a particular pitch back to the inning
in which it was thrown. Using the \texttt{add\_key} function, the relevant
value of \texttt{num} for \texttt{game//inning} observations can be
\texttt{recycle}d to its XML descendants.


```{r}
obswkey <- add_key(
  obs2, parent = "game//inning", recycle = "num", key.name = "inning"
)
```


As it turns out, the \texttt{away\_team} and \texttt{home\_team} columns
are redundant as this information is embedded in the \texttt{url} column.
Thus, there is only one other informative attribute on this level
which is \texttt{next}. By recycling this value among its descendants,
we remove any need to retain a \texttt{game//inning} table.


```{r}
obswkey <- add_key(obswkey, parent = "game//inning", recycle = "next")
```

It is also imperative that we can link a \texttt{pitch}, \texttt{runner},
or \texttt{po} back to a particular \texttt{atbat}. This can be done
as follows:

```{r}
obswkey <- add_key(obswkey, parent = "game//inning//atbat", recycle = "num")
```


## Collapsing observations

Finally, we are in a position to pool together observations that have
a common name. The \texttt{collapse\_obs} function achieves this by
row binding observations with the same name together and returning
a list of matrices. Note that \texttt{collapse\_obs} does not require
that observations from the same level to have the same set of variables
in order to be bound into a common table. In the case where variables
are missing, \texttt{NA}s will be inserted as values.


```{r}
tables <- collapse_obs(obswkey) 
#As mentioned before, we do not need the 'inning' table 
tables <- tables[!grepl("^game//inning$", names(tables))]      
table.names <- c("game", "action", "atbat", "pitch", "po", "runner") 
tables <- setNames(tables, table.names) 
head(tables[["runner"]])
```


# Collecting Gameday data with pitchRx

The main scraping function in \textbf{pitchRx}, \texttt{scrape}, can
be used to easily obtain data from the files listed in Table \@ref(tab:pitchfx).
In fact, any combination of these files can be queried using the \texttt{suffix}
argument. In the example below, the \texttt{start} and \texttt{end}
arguments are also used so that all available file types for June
1st, 2011 are queried.


```{r, eval=FALSE}
library(pitchRx)
files <- c("inning/inning_all.xml", "inning/inning_hit.xml", 
  "miniscoreboard.xml", "players.xml")
dat <- scrape(start = "2011-06-01", end = "2011-06-01", suffix = files)
```


The \texttt{game.ids} option can be used instead of \texttt{start} and
\texttt{end} to obtain an equivalent \texttt{dat} object. This option
can be useful if the user wants to query specific games rather than
all games played over a particular time span. When using this \texttt{game.ids}
option, the built-in \texttt{gids} object, is quite convenient.


```{r}
data(gids, package = "pitchRx")
gids11 <- gids[grep("2011_06_01", gids)]
head(gids11)
```

```{r, eval=FALSE}
dat <- scrape(game.ids = gids11, suffix = files)
```

The object \texttt{dat} is a list of data frames containing all data
available for June 1st, 2011 using \texttt{scrape}. The list names
match the table names provided in Table \@ref(tab:pitchfx). For
example, \texttt{dat\$atbat} is data frame with every at bat on June
1st, 2011 and \texttt{dat\$pitch} has information related to the outcome
of each pitch (including PITCHf/x parameters). The \texttt{object.size}
of \texttt{dat} is nearly 300MB. Multiplying this number by 100 days
exceeds the memory of most machines. Thus, if a large amount of data
is required, the user should exploit the R database interface [@DBI].


# Storing and querying Gameday data

Since PITCHf/x data can easily exhaust memory, one should consider
establishing a database instance before using \texttt{scrape}. By passing
a database connection to the \texttt{connect} argument, \texttt{scrape}
will try to create (and/or append to existing) tables using that connection.
If the connection fails for some reason, tables will be written as
csv files in the current working directory. The benefits of using
the \texttt{connect} argument includes improved memory management which
can greatly reduce run time. \texttt{connect} will support a MySQL
connection, but creating a SQLite database is quite easy with \textbf{dplyr}
[@dplyr]. 


```{r, eval=FALSE}
library(dplyr)
db <- src_sqlite("GamedayDB.sqlite3", create = TRUE)
# Collect and store all PITCHf/x data from 2008 to now
scrape(start = "2008-01-01", end = Sys.Date(), 
  suffix = "inning/inning_all.xml", connect = db$con)
```


In the later sections, animations of four-seam and cut fastballs thrown
by Mariano Rivera and Phil Hughes during the 2011 season are created.
In order to obtain the data for those animations, one could query
\texttt{db} which now has PITCHf/x data from 2008 to date. This query
requires criteria on: the \texttt{pitcher\_name} field (in the \texttt{atbat}
table), the \texttt{pitch\_type} field (in the \texttt{pitch} table),
and the \texttt{date} field (in both tables). To reduce the time required
to search those records, one should create an index on each of these
three fields.


```{r, eval=FALSE}
library(DBI)
dbSendQuery(db$con, "CREATE INDEX pitcher_index ON atbat(pitcher_name)") 
dbSendQuery(db$con, "CREATE INDEX type_index ON pitch(pitch_type)") 
dbSendQuery(db$con, "CREATE INDEX date_atbat ON atbat(date)") 
```


As a part of our query, we'll have to join the \texttt{atbat} table
together with the \texttt{pitch} table. For this task, the \texttt{gameday\_link}
and \texttt{num} fields are helpful since together they provide a way
to match pitches with at bats. For this reason, a multi-column index
on the \texttt{gameday\_link} and \texttt{num} fields will further reduce
run time of the query.


```{r, eval=FALSE}
dbSendQuery(db$con, 'CREATE INDEX pitch_join ON pitch(gameday_link, num)') 
dbSendQuery(db$con, 'CREATE INDEX atbat_join ON atbat(gameday_link, num)')
```


Although the query itself could be expressed entirely in SQL, \textbf{dplyr}'s
grammar for data manipulation (which is database agnostic) can help
to simplify the task. In this case, \texttt{at.bat} is a tabular \emph{representation}
of the remote \texttt{atbat} table restricted to cases where Rivera
or Hughes was the pitcher. That is, \texttt{at.bat} does not contain
the actual data, but it does contain the information necessary to
retrieve it from the database.

```{r, eval=FALSE}
at.bat <- tbl(db, "atbat") %>%   
  filter(pitcher_name %in% c("Mariano Rivera", "Phil Hughes"))
```

Similarly, \texttt{fbs} is a tabular representation of the \texttt{pitch}
table restricted to four-seam (FF) and cut fastballs (FC).

```{r, eval=FALSE}
fbs <- tbl(db, "pitch") %>%      
  filter(pitch_type %in% c("FF", "FC"))
```


An \texttt{inner\_join} of these two filtered tables returns a tabular
representation of all four-seam and cut fastballs thrown by Rivera
and Hughes. Before \texttt{collect} actually performs the database
query and brings the relevant data into the R session, another restriction
is added so that only pitches from 2011 are included.


```{r, eval=FALSE}
pitches <- inner_join(fbs, at.bat) %>% 
  filter(date >= "2011_01_01" & date <= "2012_01_01") %>%
  collect()
```


# Visualizing PITCHf/x

## Strike-zone plots and umpire bias

Amongst the most common PITCHf/x graphics are strike-zone plots. Such
a plot has two axes and the coordinates represent the location of
baseballs as they cross home plate. The term strike-zone plot can
refer to either \emph{density} or \emph{probabilistic} plots. Density
plots are useful for exploring what \emph{actually} occurred, but
probabilistic plots can help address much more interesting questions
using statistical inference. Although probabilistic plots can be used
to visually track any event probability across the strike-zone, their
most popular use is for addressing umpire bias in a strike versus
ball decision [@bias]. The probabilistic plots section demonstrates
how \textbf{pitchRx} simplifies the process behind creating such plots
via a case study on the impact of home field advantage on umpire decisions.

In the world of sports, it is a common belief that umpires (or referees)
have a tendency to favor the home team. PITCHf/x provides a unique
opportunity to add to this discussion by modeling the probability
of a called strike at home games versus away games. Specifically,
conditioned upon the umpire making a decision at a specific location
in the strike-zone, if the probability that a home pitcher receives
a called strike is higher than the probability that an away pitcher
receives a called strike, then there is evidence to support umpire
bias towards a home pitcher.

There are many different possible outcomes of each pitch, but we can
condition on the umpire making a decision by limiting to the following
two cases. A \textit{called strike} is an outcome of a pitch where the
batter does not swing and the umpire declares the pitch a strike (which
is a favorable outcome for the pitcher). A \textit{ball} is another
outcome where the batter does not swing and the umpire declares the
pitch a ball (which is a favorable outcome for the batter). All \texttt{decisions}
made between 2008 and 2013 can be obtained from \texttt{db} with the
following query using \textbf{dplyr}.


```{r, eval=FALSE}
# First, add an index on the pitch description to speed up run-time
dbSendQuery(db$con, "CREATE INDEX des_index ON pitch(des)")

pitch <- tbl(db, "pitch") %>%   
  filter(des %in% c("Called Strike", "Ball")) %>%   
  # Keep pitch location, descriptions    
  select(px, pz, des, gameday_link, num) %>%   
  # 0-1 indicator of strike/ball   
  mutate(strike = as.numeric(des == "Called Strike"))

atbat <- tbl(db, "atbat") %>%   
  # Select variables to be used later as covariates in probabilistic models
  select(b_height, p_throws, stand, inning_side, date, gameday_link, num)    

decisions <- inner_join(pitch, atbat) %>%   
  filter(date <= "2014_01_01") %>%   
  collect()
```

\subsubsection{Density plots}

The \texttt{decisions} data frame contains data on over 2.5 million
pitches thrown from 2008 to 2013. About a third of them are called
strikes and two-thirds balls. Figure \@ref(fig:STRIKES) shows the
density of all called strikes. Clearly, most called strikes occur
on the outer region of the strike-zone. Many factors could contribute
to this phenomenon; which we will not investigate here.


```{r, eval=FALSE}
# strikeFX uses the stand variable to calculate strike-zones 
# Here is a way to create better facet titles w/o changing data values
relabel <- function(variable, value) { 
  value <- sub("^R$", "Right-Handed Batter", value)
  sub("^L$", "Left-Handed Batter", value) 
}
strikes <- subset(decisions, strike == 1)
strikeFX(
  strikes, geom = "raster", 
  layer = facet_grid(. ~ stand, labeller = relabel)
)
```

\begin{figure}
\centering
\includegraphics{images/strikes-original.png}
\caption{\label{fig:STRIKES}Density of called strikes for right-handed
batters and left-handed batters (from 2008 to 2013).}
\end{figure}

Figure \@ref(fig:STRIKES) shows one static rectangle (or strike-zone)
per plot automatically generated by \texttt{strikeFX}. The definition
of the strike-zone is notoriously ambiguous. As a result, the boundaries
of the strike-zone may be noticeably different in some situations.
However, we can achieve a fairly accurate representation of strike-zones
using a rectangle defined by batters' average height and stance [@Strikezones].
As Figure \@ref(fig:strike-probs) reinforces, batter stance makes
an important difference since the strike-zone seems to be horizontally
shifted away from the batter. The batter's height is also important
since the strike-zone is classically defined as approximately between
the batter's knees and armpits.

Figure \@ref(fig:STRIKES) has is one strike-zone per plot since the
\texttt{layer} option contains a \textbf{ggplot2} argument that facets
according to batter stance. Facet layers are a powerful tool for analyzing
PITCHf/x data because they help produce quick and insightful comparisons.
In addition to using the \texttt{layer} option, one can add layers
to a graphic returned by \texttt{strikeFX} using \textbf{ggplot2} arithmetic.
It is also worth pointing out that Figure \@ref(fig:STRIKES) could
have been created without introducing the \texttt{strikes} data frame
by using the \texttt{density1} and \texttt{density2} options. 

```{r, eval=FALSE}
strikeFX(
  decisions, geom = "raster", 
  density1 = list(des = "Called Strike"),          
  density2 = list(des = "Called Strike"),
  layer = facet_grid(. ~ stand, labeller = relabel)
)
```

In general, when \texttt{density1} and \texttt{density2} are identical,
the result is equivalent to subsetting the data frame appropriately
beforehand. More importantly, by specifying \emph{different} values
for \texttt{density1} and \texttt{density2}, differenced densities are
easily generated. In this case, a grid of density estimates for \texttt{density2}
are subtracted from the corresponding grid of density estimates for
\texttt{density1}. Note that the default \texttt{NULL} value for either
density option infers that the entire data set defines the relevant
density. Thus, if \texttt{density2} was \texttt{NULL} (when \texttt{density1 = list(des = 'Called Strike')}),
we would obtain the density of called strikes minus the density of
\emph{both} called strikes and balls. In Figure \@ref(fig:strikesVSballs),
we define \texttt{density1} as called strikes and define \texttt{density2}
as balls. As expected, we see positive density values (in blue) inside
the strike-zone and negative density values (in red) outside of the
strike-zone. 

```{r, eval=FALSE}
strikeFX(
  decisions, geom = "raster", 
  density1 = list(des = "Called Strike"), 
  density2 = list(des = "Ball"), 
  layer = facet_grid(. ~ stand, labeller = relabel)
) 
```

```{r strikesVSballs, echo = FALSE, fig.cap = "Density of called strikes minus density of balls for both right-handed batters and left-handed batters (from 2008 to 2013). The blue region indicates a higher frequency of called strikes and the red region indicates a higher frequency of balls."}
knitr::include_graphics("images/strikesVSballs")
```


These density plots are helpful for visualizing the observed frequency
of events; however, they are not very useful for addressing our umpire
bias hypothesis. Instead of looking simply at the \emph{density},
we want to model the \emph{probability} of a strike called at each
coordinate given the umpire has to make a decision. 


\subsubsection{Probabilistic plots}

There are many approaches to probabilistic modeling over a two dimensional
spatial region. Since our response is often categorical, generalized
additive models (GAMs) is a popular and desirable approach to modeling
events over the strike-zone [@loess]. There are numerous R package
implementations of GAMs, but the \texttt{bam} function from the \textbf{mgcv}
package has several desirable properties [@mgcv]. Most importantly,
the smoothing parameter can be estimated using several different methods.
In order to have a reasonable estimate of the smooth 2D surface, GAMs
require fairly large amount of observations. As a result, run time
can be an issue -- especially when modeling 2.5 million observations!
Thankfully, the \texttt{bam} function has a \texttt{cluster} argument
which allows one to distribute computations across multiple cores
using the built in \textbf{parallel} package.


```{r, eval=FALSE}
library(parallel) 
cl <- makeCluster(detectCores() - 1)
library(mgcv) 
m <- bam(strike ~ interaction(stand, p_throws, inning_side) +                
  s(px, pz, by = interaction(stand, p_throws, inning_side)),              
  data = decisions, family = binomial(link = 'logit'), cluster = cl)
```


This formula models the probability of a strike as a function of the
baseball's spatial location, the batter's stance, the pitcher's throwing
arm, and the side of the inning. Since home pitchers always pitch
during the top of the inning, \texttt{inning\_side} also serves as
an indication of whether a pitch is thrown by a home pitcher. In this
case, the \texttt{interaction} function creates a factor with eight
different levels since every input factor has two levels. Consequently,
there are 8 different levels of smooth surfaces over the spatial region
defined by \texttt{px} and \texttt{pz}.

The fitted model \texttt{m} contains a lot of information which \texttt{strikeFX}
uses in conjunction with any \textbf{ggplot2} facet commands to infer
which and how surfaces should be plotted. In particular, the \texttt{var.summary}
is used to identify model covariates, as well their default conditioning
values. In our case, the majority of \texttt{decisions} are from right-handed
pitchers and the top of the inning. Thus, the default conditioning
values are \texttt{"top"} for \texttt{inning\_side} and \texttt{"R"}
for \texttt{p\_throws}. If different conditioning values are desired,
\texttt{var.summary} can be modified accordingly. To demonstrate, Figure \@ref(fig:strike-probs)
shows 2 of the 8 possible surfaces that correspond to a right-handed
\emph{away} pitcher.


```{r, eval=FALSE}
away <- list(inning_side = factor("bottom", levels = c("top", "bottom")))
m$var.summary <- modifyList(m$var.summary, away)
strikeFX(decisions, model = m, layer = facet_grid(. ~ stand, labeller = relabel))
```

```{r strike-probs, echo = FALSE, fig.cap = "Probability that a right-handed away pitcher receives a called strike (provided the umpire has to make a decision). Plots are faceted by the handedness of the batter."}
knitr::include_graphics("images/prob-strike")
```

Using the same intuition exploited earlier to obtain differenced density
plots, we can easily obtain differenced probability plots. To obtain
Figure \@ref(fig:diff-probs), we simply add \texttt{p\_throws} as
another facet variable and \texttt{inning\_side} as a differencing
variable. In this case, conditioning values do not matter since every
one of the 8 surfaces are required in order to produce Figure \@ref(fig:diff-probs).


```{r, eval=FALSE}
# Function to create better labels for both stand and p_throws
relabel2 <- function(variable, value) {    
  if (variable %in% "stand")      
    return(sub("^L$", "Left-Handed Batter",                 
      sub("^R$", "Right-Handed Batter", value)))   
  if (variable %in% "p_throws")      
    return(sub("^L$", "Left-Handed Pitcher",                 
      sub("^R$", "Right-Handed Pitcher", value))) 
}
strikeFX(
  decisions, model = m, 
  density1 = list(inning_side = "top"), 
  density2 = list(inning_side = "bottom"),
  layer = facet_grid(p_throws ~ stand, labeller = relabel2)
)
```

```{r diff-probs, echo = FALSE, fig.cap = "Difference between home and away pitchers in the probability of a strike (provided the umpire has to make a decision). The blue regions indicate a higher probability of a strike for home pitchers and red regions indicate a higher probability of a strike for away pitchers. Plots are faceted by the handedness of both the pitcher and the batter."}
knitr::include_graphics("images/prob-diff.pdf")
```


The four different plots in Figure \@ref(fig:diff-probs) represent
the four different combination of values among \texttt{p\_throws} and
\texttt{stand}. In general, provided that a pitcher throws to a batter
in the blue region, the pitch is more likely to be called a strike
if the pitcher is on their home turf. Interestingly, there is a well-defined
blue elliptical band around the boundaries of the typical strike-zone.
Thus, home pitchers are more likely to receive a favorable call --
especially when the classification of the pitch is in question. In
some areas, the home pitcher has up to a 6 percent higher probability
of receiving a called strike than an away pitcher. The subtle differences
in spatial patterns across the different values of \texttt{p\_throws}
and \texttt{stand} are interesting as well. For instance, pitching
at home has a large positive impact for a left-handed pitcher throwing
in the lower inside portion of the strike-zone to a right-handed batter,
but the impact seems negligible in the mirror opposite case.
Differenced probabilistic densities are clearly an interesting visual
tool for analyzing PITCHf/x data. With \texttt{strikeFX}, one can quickly
and easily make all sorts of visual comparisons for various situations.
In fact, one can explore and compare the probabilistic structure of
any well-defined event over a strike-zone region (for example, the
probability a batter reaches base) using a similar approach. 


## 2D animation

\texttt{animateFX} provides convenient and flexible functionality for
animating the trajectory of any desired set of pitches. For demonstration
purposes, this section animates every four-seam and cut fastball thrown
by Mariano Rivera and Phil Hughes during the 2011 season. These pitches
provide a good example of how facets play an important role in extracting
new insights. Similar methods can be used to analyze any MLB player
(or combination of players) in greater detail.

\texttt{animateFX} tracks three dimensional pitch locations over a
sequence of two dimensional plots. The animation takes on the viewpoint
of the umpire; that is, each time the plot refreshes, the balls are
getting closer to the viewer. This is reflected with the increase
in size of the points as the animation progresses. Obviously, some
pitches travel faster than others, which explains the different sizes
within a particular frame. Animations revert to the initial point
of release once \emph{all} of the baseballs have reached home plate.
During an interactive session, \texttt{animateFX} produces a series
of plots that may not viewed easily. One option available to the user
is to wrap \texttt{animation::saveHTML} around \texttt{animateFX} to
view the animation in a browser with proper looping controls [@animation].

To reduce the time and thinking required to produce these animations,
\texttt{animateFX} has default settings for the geometry, color, opacity
and size associated with each plot. Any of these assumptions can be
altered - except for the point geometry. In order for animations to
work, a data frame with the appropriately named PITCHf/x parameters
(that is, x0, y0, z0, vx0, vy0, vz0, ax0, ay0 and az0) is required.
In Figure \@ref(fig:animate1), every four-seam and cut fastball thrown
by Rivera and Hughes during the 2011 season is visualized using the
\texttt{pitches} data frame obtained earlier (the animation is available
at \url{http://cpsievert.github.io/pitchRx/ani1}).


```{r, eval=FALSE}
animateFX(pitches, layer=list(theme_bw(), coord_equal(),
  facet_grid(pitcher_name~stand, labeller = relabel)))
```

```{r animate1, echo = FALSE, fig.cap = "The last frame of an animation of every four-seam and cutting fastballs thrown by NY Yankee pitchers Mariano Rivera and Phil Hughes during the 2011 season. The actual animation can be viewed at <http://cpsievert.github.io/pitchRx/ani1>. Pitches are faceted by pitcher and batting stance. For instance, the top left plot portrays pitches thrown by Rivera to left-handed batters."}
knitr::include_graphics("images/ani-frame1")
```

In the animation corresponding to Figure \@ref(fig:animate1), the
upper right-hand portion (Rivera throwing to right-handed batters)
reveals the clearest pattern in flight trajectories. Around the point
of release, Rivera's two pitch types are hard to distinguish. However,
after a certain point, there is a very different flight path among
the two pitch types. Specifically, the drastic left-to-right movement
of the cut fastball is noticeably different from the slight right-to-left
movement of the four-seam fastball. In recent years, cut fastballs
have gained notoriety among the baseball community as a coveted pitch
for pitchers have at their disposal. This is largely due to the difficulty
that a batter has in distinguishing the cut fastball from another
fastball as the ball travels toward home plate. Clearly, this presents
an advantage for the pitcher since they can use deception to reduce
batter's ability to predict where the ball will cross home plate.
This deception factor combined with Rivera's ability to locate his
pitches explain his accolades as one of the greatest pitchers of all
time [@NYT].

Although we see a clear pattern in Rivera's pitches, MLB pitchers
are hardly ever that predictable. Animating that many pitches for
another pitcher can produce a very cluttered graphic which is hard
to interpret (especially when many pitch types are considered). However,
we may still want to obtain an indication of pitch trajectory over
a set of many pitches. A way to achieve this is to average over the
PITCHf/x parameters to produce an overall sense of pitch type behavior
(via the \texttt{avg.by} option). Note that the facet variables are
automatically considered indexing variables. That is, in Figure \@ref(fig:animate2),
there are eight 'average' pitches since there are two pitch types,
two pitchers, and two types of batting stance (the animation is available
at \url{http://cpsievert.github.io/pitchRx/ani2}).


```{r, eval=FALSE}
animateFX(
  pitches, avg.by = "pitch_types", 
  layer = list(
    coord_equal(), theme_bw(), 
    facet_grid(pitcher_name ~ stand, labeller = relabel)
  )
)
```

```{r animate2, echo = FALSE, fig.cap = "The last frame of an animation of averaged four-seam and cutting fastballs thrown by NY Yankee pitchers Mariano Rivera and Phil Hughes during the 2011 season. The actual animation can be viewed at <http://cpsievert.github.io/pitchRx/ani2>. PITCHf/x parameters are averaged over pitch type, pitcher and batting stance. For instance, the bottom right plot portrays an average four-seam and average cutter thrown by Hughes to right-handed batters."}
knitr::include_graphics("images/ani-frame2")
```


## Interactive 3D graphics

\textbf{rgl} is an R package that utilizes OpenGL for graphics rendering.
\texttt{interactiveFX} utilizes \textbf{rgl} functionality to reproduce
flight paths on an interactive 3D platform. Figure \@ref(fig:rgl)
has two static pictures of Mariano Rivera's 2011 fastballs on this
interactive platform. This is great for gaining new perspectives on
a certain set of pitches, since the trajectories can be viewed from
any angle. Figure \@ref(fig:rgl) showcases the difference in trajectory
between Rivera's pitch types.


```{r, eval=FALSE}
Rivera <- subset(pitches, pitcher_name == "Mariano Rivera")
interactiveFX(Rivera, avg.by = "pitch_types")
```

```{r rgl, echo = FALSE, fig.show = 'hold', fig.cap = "3D scatterplot of pitches from Rivera. Pitches are plotted every one-hundredth of a second. Cutting fastballs are shown in red and four-seam fastballs are shown in blue. The left hand plot takes a viewpoint of Rivera and the right hand plot takes a viewpoint near the umpire. Note these are static pictures of an interactive object."}
knitr::include_graphics("images/rgl")
```

# Conclusion

\textbf{pitchRx} utilizes \textbf{XML2R}'s convenient framework for manipulating
XML content in order to provide easy access to PITCHf/x and related
Gameday data. \textbf{pitchRx} removes access barriers which allows
the average R user and baseball fan to spend their valuable time analyzing
Gameday's enormous source of baseball information. \textbf{pitchRx}
also provides a suite of functions that greatly reduce the amount
of work involved to create popular PITCHf/x graphics. For those interested
in obtaining other XML data, \textbf{pitchRx} serves as a nice example
of leveraging \textbf{XML2R} to quickly assemble custom XML data collection
mechanisms.
